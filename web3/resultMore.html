<!DOCTYPE html>
<html>
<head>
	<title>More Result</title>
</head>
<body>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
	<h1>More Result</h1>

	<div ng-app="myApp" ng-controller="myCtrl">
		<div ng-repeat="list in informationList">&emsp;
			<br><a>At : {{list.timestamp}}</a>
			<br><a>File Name : {{list.video_path}}</a>
			<a href={{list.download}}> download</a>
			<br>
		</div>
	</div>
	<br>
	<button value="prev" onclick="prev()">Prev</button>
	<button value="next" onclick="next()">Next</button>

<script>
	var percent_color = 10;
	var serverResult = null;
	searchParams = new URLSearchParams(location.search);
	console.log("token_param : " + searchParams.get('camera_token'));
	var camera_token = searchParams.get('camera_token');
	console.log("stage : "+searchParams.get('stage'));
	var stage = searchParams.get('stage');
	var app = angular.module('myApp', [])
	function getCookie(cname) {
			name = cname + "=";
			var decodedCookie = decodeURIComponent(document.cookie);
			var ca = decodedCookie.split(';');
			for(var i = 0; i <ca.length; i++) {
					var c = ca[i];
					while (c.charAt(0) == ' ') {
							c = c.substring(1);
					}
					if (c.indexOf(name) == 0) {
							return c.substring(name.length, c.length);
					}
			}
			return "";
	}
	function normalize(data){
		if(data > 255 || data < 0){
			if(data > 255){
				return 255;
			}
			else if(data < 0){
				return 0;
			}
		}
		else{
			return data;
		}
	}
	function checkNull(value){
			if(value == "null"){
				return null;
			}
			else{
				return value;
			}
	}

	function checkNan(value){
			if(isNaN(value)){
				return null;
			}
			else{
				return value;
			}
	}

	face 			= checkNull(localStorage.getItem("face"));
	red_min 	= checkNan(normalize(Math.floor(parseInt(localStorage.getItem("color").slice(0, 2),16)*(100-percent_color)/100)));
	red_max		= checkNan(normalize(Math.floor(parseInt(localStorage.getItem("color").slice(0, 2),16)*(100+percent_color)/100)));
	green_min	= checkNan(normalize(Math.floor(parseInt(localStorage.getItem("color").slice(2, 4),16)*(100-percent_color)/100)));
	green_max	= checkNan(normalize(Math.floor(parseInt(localStorage.getItem("color").slice(2, 4),16)*(100+percent_color)/100)));
	blue_min 	= checkNan(normalize(Math.floor(parseInt(localStorage.getItem("color").slice(4, 6),16)*(100-percent_color)/100)));
	blue_max 	= checkNan(normalize(Math.floor(parseInt(localStorage.getItem("color").slice(4, 6),16)*(100+percent_color)/100)));
	date  		= checkNull(localStorage.getItem("date"));
	toDate    = checkNull(localStorage.getItem("toDate"));
	floor	    = checkNull(localStorage.getItem("floor"));

	if(red_min && red_max && green_min && green_max && blue_min && blue_max){
		red 	= [ red_min , red_max ];
		green = [ green_min , green_max ];
		blue 	= [ blue_min , blue_max ];
	}
	else{
		red 	= [];
		green = [];
		blue 	= [];
	}

	if(date == null || toDate == null){
		jdate = [];
	}
	else{
		jdate = [date,toDate];
	}

	if(floor){
		floor = [floor];
	}
	else{
		floor = [];
	}

	function downloadPath(path){
		temp = "/ipcam/"+path.slice(14,22)+"/"+path.slice(22,24)+"00/"+path.slice(6,32);
		console.log("temp : "+temp);
		return temp;
	}

	app.controller('myCtrl', function ($scope, $http) {
		$scope.data = {
				"pic_search"	: face,
				"red"					: red,
				"green"				: green,
				"blue"				: blue,
				"date"				: jdate,
				"floor"				: floor,
				"stage"				: stage
		};
		console.log($scope.data);
		var token = 'Basic '+getCookie("auth");
		$scope.config = {
			headers: {
				'Authorization' : token
			}
		};
		$http.post("http://161.246.5.160:8000/search/", $scope.data , $scope.config)
		.then(function(response) {
			console.log("response from server : ");
			console.log(response);
			serverResult = response;
			//listOfFileName(0,20);



			$scope.informationList = [];
			if(serverResult.data.length == 0){
				console.log("No result");
				$scope.masg = "No Result";
			}
			else{
				for(var i=0 ; i<serverResult.data.length ; i++){
					if(serverResult.data[i].token == camera_token){
						if($scope.informationList.length == 0){
							for(var j=0 ; j<serverResult.data[i].list_video.length ; j++){
								$scope.timeTemp = serverResult.data[i].list_video[j].video_name;
								$scope.newTime = $scope.timeTemp.slice(8,10)+':'+$scope.timeTemp.slice(10,12)+':'+$scope.timeTemp.slice(12,14)+' '+$scope.timeTemp.slice(6,8)+'/'+$scope.timeTemp.slice(4,6)+'/'+$scope.timeTemp.slice(0,4);
								console.log($scope.newTime);
								$scope.informationList[j] =
								{	timestamp 	: $scope.newTime,
									download 		: serverResult.data[i].list_video[j].video_path,
									video_path 	: serverResult.data[i].list_video[j].video_name								};
							}
						}
					}
				}
				console.log("end");
				console.log($scope.informationList);
			}
		});
	});
	function next(){
		if(serverResult.data.length >= 3){
			console.log("http://161.246.5.152/resultMore.html/?camera_token="+camera_token+"&?stage="+(parseInt(stage)+1));
			window.location.href = "http://161.246.5.152/resultMore.html/?camera_token="+camera_token+"&stage="+(parseInt(stage)+1);
		}
	}
	function prev(){
		if(stage > 1){
			window.location.href = "http://161.246.5.152/resultMore.html/?camera_token="+camera_token+"&stage="+(parseInt(stage)-1);
		}
	}
</script>

</body>
</html>
